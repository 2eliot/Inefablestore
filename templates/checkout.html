{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/store.css', v='2') }}">
<style>
  .co-wrap { max-width: 900px; margin: 0 auto; padding: 16px 12px 28px; }
  .co-banner { background: #10b981; color: #0b0f14; font-weight: 900; border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 16px; }
  /* Charcoal card style */
  .co-card { background: rgba(43,47,54,0.4); border:1px solid rgba(148,163,184,0.1); border-radius: 14px; padding: 12px; margin-bottom: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
  .co-card h3 { margin: 0 0 8px; color: #e2e8f0; font-weight: 900; text-align:center; padding-bottom:10px; border-bottom:1px solid rgba(148,163,184,0.1); }
  /* Info rows with icon + value + copy */
  #co-info { display:grid; gap:12px; }
  .co-item { display:grid; grid-template-columns: 28px 1fr auto; align-items:center; gap:10px; }
  .co-ico { width:28px; height:28px; display:flex; align-items:center; justify-content:center; color:#cbd5e1; }
  .co-val { color:#e2e8f0; font-weight:800; }
  .copy-btn { border:1px solid rgba(148,163,184,0.1); background: rgba(43,47,54,0.3); color:#e2e8f0; border-radius:8px; padding:6px 8px; font-size:12px; cursor:pointer; }
  .copy-btn:hover { background: rgba(43,47,54,0.45); border-color: rgba(148,163,184,0.18); }
  .co-actions { margin-top: 10px; }
  .co-actions .btn { width: 100%; }
  /* Reference input emphasis */
  .ref-group { display:grid; gap:8px; justify-items: center; }
  .ref-label { color:#cbd5e1; font-weight:800; font-size:13px; letter-spacing:.2px; }
  .ref-hint { color: #94a3b8; font-size: 12px; margin-top: -2px; }
  #co-ref.input { 
    padding: 12px 14px; 
    border-width: 2px; 
    border-color: rgba(148,163,184,0.25); 
    border-radius: 10px;
    background: rgba(43,47,54,0.3);
    color:#e5e7eb;
    outline: none;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  #co-ref.input::placeholder { color: #94a3b8; }
  #co-ref.input:focus { border-color:#10b981; box-shadow: 0 0 0 3px rgba(16,185,129,0.25); }
  /* Wrapper to place the Paste button inside the input */
  .ref-input-wrap { position: relative; width: 100%; max-width: 480px; margin: 0 auto; }
  .ref-input-wrap #co-ref.input { width: 100%; box-sizing: border-box; padding-right: 120px; padding-left: 120px; }
  .ref-input-wrap #btn-paste-ref {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    height: calc(100% - 8px);
    padding: 0 14px;
    min-width: 90px;
    width: auto !important;
    z-index: 1;
    background: transparent !important;
    border: none !important;
    color: #10b981 !important;
    box-shadow: none !important;
    font-weight: 900 !important;
    border-left: 1px solid rgba(148,163,184,0.28) !important;
  }
  .co-hint { color: #94a3b8; font-size: 12px; margin-top: 6px; text-align: center; }
  /* Discount price styling */
  .price-old { text-decoration: line-through; color: rgba(148,163,184,0.6); margin-right: 8px; font-weight: 800; }
  .price-new { color: #0b0f14; background: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 8px; font-weight: 900; }
  .discount-badge { text-decoration: line-through; color: #cbd5e1; border: 2px solid rgba(148,163,184,0.35); padding: 2px 6px; border-radius: 8px; font-weight: 900; margin-right: 8px; background: rgba(148,163,184,0.15); }
  /* Discount block styled like other cards */
  #co-disc-note { background: rgba(43,47,54,0.4); border:1px solid rgba(148,163,184,0.1); border-radius: 14px; padding: 12px; margin: 0 0 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); color:#e2e8f0; text-align:center; font-weight:900; width: 100%; max-width: 100%; }
  .co-disc-note { text-align:center; color:#e2e8f0; font-weight:900; }
  .co-disc-note[hidden] { display: none; }
  /* Phone tweaks: keep input text fully visible and centered */
  @media (max-width: 480px) {
    .ref-input-wrap { max-width: 100%; }
    .ref-input-wrap #btn-paste-ref { right: 4px; min-width: 72px; padding: 0 10px; }
    .ref-input-wrap #co-ref.input { padding-right: 92px; padding-left: 92px; font-size: 14px; }
  }
  /* Button disabled state - very visual */
  #btn-co-confirm {
    position: relative;
    transition: all 0.3s ease;
  }
  #btn-co-confirm:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    background: rgba(43,47,54,0.3) !important;
    color: #6b7280 !important;
    border: 2px dashed rgba(148,163,184,0.25) !important;
    transform: none !important;
    filter: grayscale(1);
  }
  #btn-co-confirm:disabled:hover {
    background: rgba(43,47,54,0.3) !important;
    transform: none !important;
  }
  #btn-co-confirm:not(:disabled) {
    animation: pulse-ready 2s infinite;
  }
  @keyframes pulse-ready {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
  }
  /* Digit counter */
  .digit-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-top: 6px;
  }
  .digit-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(43,47,54,0.45);
    border: 2px solid rgba(148,163,184,0.18);
    transition: all 0.2s ease;
  }
  .digit-dot.filled {
    background: #10b981;
    border-color: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
  }
  .ref-counter-text {
    color: #94a3b8;
    font-size: 11px;
    text-align: center;
    margin-top: 4px;
    font-weight: 600;
  }
  /* Floating blocked message */
  .blocked-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.65); display: none; align-items: center; justify-content: center; z-index: 1000; }
  .blocked-card { position: relative; width: min(92vw, 520px); background: #111827; border: 1px solid #374151; border-radius: 14px; padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); color: #e5e7eb; }
  .blocked-close { position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: #9ca3af; font-size: 18px; cursor: pointer; }
  .blocked-title { margin: 4px 0 8px; font-weight: 900; color: #fca5a5; }
  .blocked-text { color: #cbd5e1; line-height: 1.45; }
  .blocked-actions { display: flex; gap: 8px; margin-top: 12px; }
  .btn-whatsapp { background: #22c55e; color: #062a1d; border: none; border-radius: 10px; padding: 10px 12px; font-weight: 900; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
  .btn-whatsapp:hover { filter: brightness(1.05); }
  @media (max-width: 700px) {
    .co-wrap { padding-left: 10px; padding-right: 10px; }
  }
</style>
{% endblock %}

{% block header %}
<header class="site-header">
  <div class="container">
    <div class="left-actions">
      <a href="/" class="icon-btn" aria-label="Volver" title="Volver">‹</a>
    </div>
    <a href="/" class="brand">
      {% if logo_url %}
        <img src="{{ logo_url }}" alt="{{ site_name|default('InefableStore') }}" class="logo"/>
      {% else %}
        <span class="logo-text">{{ site_name|default('InefableStore') }}</span>
      {% endif %}
    </a>
    <div class="right-actions">
      <div class="header-search" role="search">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input id="header-search" type="search" placeholder="Buscar Juegos" autocomplete="off" />
      </div>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
<section class="co-wrap" id="checkout" data-gid="{{ gid }}" data-whatsapp="{{ whatsapp_url }}" data-gname="{{ game_name }}" data-gimg="{{ game_image }}">
  <div class="co-banner" id="co-total">
    <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:8px;">
      {% if game_image %}
        <img src="{{ game_image }}" alt="{{ game_name or 'Juego' }}" style="width:40px; height:40px; object-fit:cover; border-radius:8px; border:1px solid rgba(148,163,184,0.18);">
      {% endif %}
      {% if game_name %}
        <div style="color:#0b0f14; background:rgba(255,255,255,0.75); padding:2px 8px; border-radius:8px; font-weight:900;">{{ game_name }}</div>
      {% endif %}
    </div>
    <div style="font-weight:900;">Total a pagar</div>
  </div>
  <div id="co-disc-note" class="co-disc-note" hidden></div>

  <div class="co-card">
    <h3>Información de pago</h3>
    <div id="co-info"></div>
  </div>

  <div class="co-card">
    <h3>Tiempo restante para completar el pago</h3>
    <div id="co-timer" style="text-align:center; font-weight:800;">30:00</div>
    <div class="co-actions">
      <div class="ref-group">
        <div class="ref-label-row" style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:6px;">
          <label for="co-ref" class="ref-label" style="text-align: center; font-weight: 800; margin:0;">COLOCA TU REFERENCIA AQUI</label>
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true" style="color:#94a3b8;">
            <path d="M12 16l-6-6h12l-6 6z"/>
          </svg>
        </div>
        <div class="ref-input-wrap">
          <input id="co-ref" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="NUMERO DE REFERENCIA DE PAGO" required style="text-align: center;">
          <button id="btn-paste-ref" type="button" class="btn" aria-label="Pegar referencia" title="Pegar" style="font-weight:800;">Pegar</button>
        </div>
        <div class="digit-counter" id="digit-counter"></div>
        <div class="ref-counter-text" id="ref-counter" style="text-align: center;">0 dígitos</div>
        <div id="ref-error" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: none;"></div>
      </div>
      <button id="btn-co-confirm" class="btn primary" type="button" style="margin-top:10px;">Confirmar Pago</button>
    </div>
  </div>
</section>
<div id="blocked-overlay" class="blocked-overlay" role="dialog" aria-modal="true" aria-labelledby="blocked-title" aria-hidden="true">
  <div class="blocked-card">
    <button id="blocked-close" class="blocked-close" aria-label="Cerrar">✕</button>
    <h3 id="blocked-title" class="blocked-title">ID bloqueado por los Moderadores</h3>
    <p class="blocked-text">Este ID ha sido bloqueado por los Moderadores. Si crees que esto fue un error por favor contacta al soporte.</p>
    <div class="blocked-actions">
      <a id="blocked-whatsapp" href="#" target="_blank" rel="noopener" class="btn-whatsapp">
        <span>Contactar por WhatsApp</span>
      </a>
    </div>
  </div>
  </div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/checkout.js', v='4') }}" defer></script>
{% endblock %}
